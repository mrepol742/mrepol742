name: Snippet

on:
  #schedule:
  #  - cron: '0 0 * * *'
  workflow_dispatch:
  workflow_run:
    workflows: ["Waka Readme"]
    types:
      - completed

permissions:
  models: read

jobs:
  snippet:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
      - name: Generate Snippets
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          RESPONSE=$(curl "https://models.github.ai/inference/chat/completions" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $GITHUB_TOKEN" \
          -d "{\"messages\": [{\"role\": \"user\", \"content\": \"generated-code: Suggest a code snippet that demonstrates an interesting or quirky programming trick, suitable for displaying in a GitHub README. Include a brief comment above the code explaining what it does. coding-challenges: Create a bite-sized daily coding challenge for  programmers for a GitHub README that will use research, critical thinking and problem solving. The challenge should also mention the programming language. Example format: \\\"Write a function that removes duplicate values from an array without using Set or filter in JS.\\\" must output in JSON format using this structure { generatedCode: ' ', codingChallenges: ' ' }\"}], \"model\": \"openai/gpt-5\"}"
          )

          MESSAGE=$(node -pe 'JSON.parse(process.argv[1]).choices[0].message.content' "$RESPONSE")
          GENERATED_CODE=$(node -pe 'JSON.parse(process.argv[1]).generatedCode' "$MESSAGE")
          CODING_CHALLENGE=$(node -pe 'JSON.parse(process.argv[1]).codingChallenges' "$MESSAGE")

          SNIPPET_CONTENT=$(cat <<EOF
          <!--START_SECTION:footer-->
          ### Code Snippet
          \`\`\`js
          $GENERATED_CODE
          \`\`\`
          ### Challenge
          $CODING_CHALLENGE
          <!--END_SECTION:footer-->
          EOF
          )

          awk -v snippet="$SNIPPET_CONTENT" '
            BEGIN { in_section=0 }
            /<!--START_SECTION:footer-->/ { print snippet; in_section=1; next }
            /<!--END_SECTION:footer-->/ { in_section=0; next }
            !in_section { print }
          ' README.md > README.tmp && mv README.tmp README.md

      - name: Set up Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push
        run: |
          git add .
          git commit -m "feat: Updated Snippet"
          git push origin master
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
